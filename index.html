import feedparser
import requests
import os
import re
from datetime import datetime, timedelta

# --- 配置区：更丰富的 AI 资讯源 ---
RSS_SOURCES = [
    "https://rsshub.app/twitter/user/OpenAI",           # OpenAI X 动态
    "https://rsshub.app/twitter/user/GoogleDeepMind",   # Google DeepMind
    "https://rsshub.app/twitter/user/AnthropicAI",     # Anthropic (Claude 官方)
    "https://www.theverge.com/ai-artificial-intelligence/rss/index.xml", # The Verge AI
    "https://feeds.feedburner.com/TechCrunch/AI",       # TechCrunch AI 频道
    "https://news.google.com/rss/search?q=AI+news+when:10d&hl=zh-CN&gl=CN&ceid=CN:zh-Hans" # 谷歌新闻近10天
]

def get_ai_summary(text):
    api_key = os.getenv("KUAI_API_KEY")
    if not api_key: return "（未配置 API Key）"
    
    # 强制 AI 总结得极其精炼
    prompt = f"你是AI深度观察者，请用一句话总结以下内容最核心的干货（不超过30字）：\n{text}"
    url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key={api_key}"
    headers = {'Content-Type': 'application/json'}
    data = {"contents": [{"parts": [{"text": prompt}]}]}
    
    try:
        response = requests.post(url, headers=headers, json=data, timeout=15)
        return response.json()['candidates'][0]['content']['parts'][0]['text']
    except:
        return "精华加载中..."

def run_update():
    all_news = []
    ten_days_ago = datetime.now() - timedelta(days=10)
    print(f"正在扫描近10天（{ten_days_ago.strftime('%Y-%m-%d')}之后）的全球 AI 资讯...")

    for url in RSS_SOURCES:
        try:
            feed = feedparser.parse(url)
            for entry in feed.entries:
                # 尝试获取新闻时间
                pub_date = None
                if 'published_parsed' in entry:
                    pub_date = datetime(*entry.published_parsed[:6])
                
                # 如果有日期且在10天内，或者没有日期（有些源不给日期）则默认抓取
                if pub_date is None or pub_date > ten_days_ago:
                    summary = get_ai_summary(entry.title)
                    all_news.append({
                        "title": entry.title,
                        "date": pub_date.strftime("%Y-%m-%d") if pub_date else datetime.now().strftime("%Y-%m-%d"),
                        "summary": summary
                    })
                
                if len(all_news) >= 30: break # 总数达到30条就停止，防止网页太长
        except:
            continue

    if not all_news: return

    # 按照日期排序，最新的在上面
    all_news.sort(key=lambda x: x['date'], reverse=True)

    with open("index.html", "r", encoding="utf-8") as f:
        html_content = f.read()

    # 构建 HTML 模块
    news_html = '<div class="news-preview">
        <div class="news-card">
            <span class="date-tag">2026-01-16</span>
            <div class="news-title">从概念到落地，“物理AI”的“ChatGPT时刻”来了吗 - 新华网</div>
            <p class="news-summary">（未配置 API Key）</p>
        </div>
        
        <div class="news-card">
            <span class="date-tag">2026-01-16</span>
            <div class="news-title">高通在CES展会上将AI计算带入个人电脑、机器人和车辆 - 新浪网</div>
            <p class="news-summary">（未配置 API Key）</p>
        </div>
        </div>
            <p class="news-summary">（未配置 API Key）</p>
        </div>
        
        <div class="news-card">
            <span class="date-tag">2026-01-16</span>
            <div class="news-title">高通在CES展会上将AI计算带入个人电脑、机器人和车辆 - 新浪网</div>
            <p class="news-summary">（未配置 API Key）</p>
        </div>
        </div>
            <p class="news-summary">{item["summary"]}</p>
        </div>
        '''
    news_html += '</div>'

    new_content = re.sub(r'<div class="news-preview">
        <div class="news-card">
            <span class="date-tag">2026-01-16</span>
            <div class="news-title">从概念到落地，“物理AI”的“ChatGPT时刻”来了吗 - 新华网</div>
            <p class="news-summary">（未配置 API Key）</p>
        </div>
        
        <div class="news-card">
            <span class="date-tag">2026-01-16</span>
            <div class="news-title">高通在CES展会上将AI计算带入个人电脑、机器人和车辆 - 新浪网</div>
            <p class="news-summary">（未配置 API Key）</p>
        </div>
        </div>
            <p class="news-summary">（未配置 API Key）</p>
        </div>
        
        <div class="news-card">
            <span class="date-tag">2026-01-16</span>
            <div class="news-title">高通在CES展会上将AI计算带入个人电脑、机器人和车辆 - 新浪网</div>
            <p class="news-summary">（未配置 API Key）</p>
        </div>
        </div>', news_html, html_content, flags=re.DOTALL)

    with open("index.html", "w", encoding="utf-8") as f:
        f.write(new_content)
    print(f"更新成功！共抓取到 {len(all_news)} 条高质量资讯。")

if __name__ == "__main__":
    run_update()
